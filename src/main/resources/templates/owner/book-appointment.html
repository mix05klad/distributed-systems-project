<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="el">
<head>
    <meta charset="UTF-8">
    <title>Book Appointment</title>
</head>
<body>

<h2>Book Appointment</h2>

<!-- Success -->
<div th:if="${successMessage}">
    <p th:text="${successMessage}" style="color:green;"></p>
</div>

<!-- Warning (non-blocking) -->
<div th:if="${warningMessage}">
    <p th:text="${warningMessage}"
       style="color:#856404; background:#fff3cd; border:1px solid #ffeeba; padding:10px;"></p>
</div>

<div th:if="${errorMessage}">
    <p th:text="${errorMessage}" style="color:red;"></p>
</div>

<form th:action="@{/ui/owner/book-appointment}"
      th:object="${appointmentForm}"
      method="post">

    <!-- Pet -->
    <div>
        <label>Pet</label>
        <select th:field="*{petId}">
            <option value="" disabled
                    th:selected="${appointmentForm.petId == null}">-- Select pet --</option>
            <option th:each="p : ${pets}"
                    th:value="${p.id}"
                    th:text="${p.name}">
            </option>
        </select>
        <div th:if="${#fields.hasErrors('petId')}"
             th:errors="*{petId}" style="color:red;"></div>
    </div>

    <!-- Vet -->
    <div>
        <label>Vet</label>
        <select th:field="*{vetId}" id="vetSelect"
                onchange="onVetChange(this)">
            <option value="" disabled
                    th:selected="${appointmentForm.vetId == null}">-- Select vet --</option>
            <option th:each="v : ${vets}"
                    th:value="${v.id}"
                    th:text="${v.fullName}"></option>
        </select>
        <div th:if="${#fields.hasErrors('vetId')}"
             th:errors="*{vetId}" style="color:red;"></div>
    </div>

    <!-- Εμφάνιση διαθεσιμότητας επιλεγμένου vet -->
    <div th:if="${selectedVetAvailability != null}">
        <h3>Availability for selected vet</h3>

        <table border="1" th:if="${!selectedVetAvailability.isEmpty()}">
            <tr>
                <th>Start</th>
                <th>End</th>
            </tr>
            <tr th:each="slot : ${selectedVetAvailability}">
                <td th:text="${slot.startTime}">start</td>
                <td th:text="${slot.endTime}">end</td>
            </tr>
        </table>

        <p th:if="${selectedVetAvailability.isEmpty()}">
            This vet has no declared availability.
        </p>
    </div>

    <!-- Visit type -->
    <div>
        <label>Visit type</label>
        <select th:field="*{visitType}">
            <option value="" disabled
                    th:selected="${appointmentForm.visitType == null}">
                -- Select visit type --
            </option>
            <option th:each="t : ${T(gr.hua.dit.petcare.core.model.VisitType).values()}"
                    th:value="${t}"
                    th:text="${t}"></option>
        </select>
        <div th:if="${#fields.hasErrors('visitType')}"
             th:errors="*{visitType}" style="color:red;"></div>
    </div>

    <!-- Start -->
    <div>
        <label>Start</label>
        <input type="datetime-local" th:field="*{startTime}"/>
        <div th:if="${#fields.hasErrors('startTime')}"
             th:errors="*{startTime}" style="color:red;"></div>
    </div>

    <!-- End -->
    <div>
        <label>End</label>
        <input type="datetime-local" th:field="*{endTime}"/>
        <div th:if="${#fields.hasErrors('endTime')}"
             th:errors="*{endTime}" style="color:red;"></div>
    </div>

    <div>
        <button type="submit">Book</button>
        <button type="button" onclick="location.href='/ui/owner/home'">Back to Dashboard</button>
    </div>
</form>

<hr/>

<h2>Your Appointments</h2>

<table border="1" th:if="${appointments != null && !appointments.isEmpty()}">
    <tr>
        <th>Pet</th>
        <th>Vet</th>
        <th>Start</th>
        <th>End</th>
        <th>Status</th>
    </tr>
    <tr th:each="a : ${appointments}">
        <td th:text="${a.petName}">Pet</td>
        <td th:text="${a.vetName}">Vet</td>
        <td th:text="${a.startTime}">Start</td>
        <td th:text="${a.endTime}">End</td>
        <td th:text="${a.status}">Status</td>
    </tr>
</table>

<div th:if="${appointments == null || appointments.isEmpty()}">
    <p>You have no appointments yet.</p>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
        function onVetChange(selectElem) {
            const vetId = selectElem.value;
            if (!vetId) return;

            const url = new URL(window.location.href);
            url.searchParams.set('vetId', vetId);
            window.location.href = url.toString();
        }

        // true αν υπάρχει success ή error μήνυμα στο model
        var hasMessage = /*[[${successMessage != null or warningMessage != null or errorMessage != null}]]*/ false;


        document.addEventListener("DOMContentLoaded", function () {
            // Αν μόλις κάναμε book , δεν κάνει redirect,
            // ο χρήστης προλαβαίνει να δει το μνμ
            if (hasMessage) {
                return;
            }

            const vetSelect = document.getElementById("vetSelect");
            if (vetSelect && vetSelect.value) {
                const url = new URL(window.location.href);
                if (!url.searchParams.has("vetId")) {
                    url.searchParams.set("vetId", vetSelect.value);
                    window.location.replace(url.toString());
                }
            }
        });
    /*]]>*/
</script>


</body>
</html>
